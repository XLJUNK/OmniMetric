name: Global Macro Signal Update
on:
  push:
    branches: [ main ]
  schedule:
    - cron: '5 * * * *' # Every hour at :05 (User Decision: Hourly)
  workflow_dispatch:

concurrency:
  group: update-signal
  cancel-in-progress: true # Cancel previous run if still executing

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip' # Requires requirements.txt to be present
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install --no-deps pandas-ta
      - name: Install Node dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Cache Fonts
        id: cache-fonts
        uses: actions/cache@v3
        with:
          path: backend/assets/fonts
          key: noto-fonts-v1
      
      - name: Install Fonts
        if: steps.cache-fonts.outputs.cache-hit != 'true'
        run: |
          mkdir -p backend/assets/fonts
          echo "Downloading Noto Sans Fonts (cache miss)..."
          curl -fL -o backend/assets/fonts/NotoSansJP-Bold.ttf "https://github.com/google/fonts/raw/main/ofl/notosansjp/NotoSansJP-Bold.ttf" || echo "Failed to download JP font"
          curl -fL -o backend/assets/fonts/NotoSansSC-Bold.ttf "https://github.com/google/fonts/raw/main/ofl/notosanssc/NotoSansSC-Bold.ttf" || echo "Failed to download SC font"
          curl -fL -o backend/assets/fonts/NotoSansDevanagari-Bold.ttf "https://github.com/google/fonts/raw/main/ofl/notosansdevanagari/NotoSansDevanagari-Bold.ttf" || echo "Failed to download Devanagari font"
          curl -fL -o backend/assets/fonts/NotoSansArabic-Bold.ttf "https://github.com/google/fonts/raw/main/ofl/notosansarabic/NotoSansArabic-Bold.ttf" || echo "Failed to download Arabic font"
          ls -lh backend/assets/fonts/
      - name: Sync and Run Engine
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          AI_GATEWAY_API_KEY: ${{ secrets.AI_GATEWAY_API_KEY }}
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --hard origin/main
          
          # PATH DEBUGGING
          echo "Current Directory: $(pwd)"
          
          python backend/gms_engine.py
          
          # FORCE NEWS UPDATE (Fix for empty translations)
          # [DISABLED] Redundant: gms_engine.py already calls fetch_news (Double Billing Fix)
          # python backend/fetch_news.py
          
          # SKILL COMPLIANCE CHECK (Blocks commit if failed)
          python scripts/verify_skills.py

          # FRONTEND SYNC: Copy signal to frontend/data for import
          mkdir -p frontend/data
          cp backend/current_signal.json frontend/data/current_signal.json
          
          git add backend/current_signal.json backend/history.json backend/archive/*.json frontend/data/current_signal.json
          git commit -m "Auto-update market signal [bot]" || echo "No changes to commit"
          
          # Pull with rebase in case wiki or other workflow updated remote
          git pull --rebase origin main || echo "Already up to date"
          
          git push origin main
          
          # VISIBILITY: Always show logs
          echo "=== NEWS DEBUG LOG ==="
          cat backend/news_debug.log || echo "No news log found"
          echo "=== ENGINE LOG ==="
          cat backend/engine_log.txt || echo "No engine log found"

      - name: Ping IndexNow
        if: success()
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          if [ -n "$INDEXNOW_KEY" ]; then
            echo "Pinging IndexNow (Bing/Yandex)..."
            # Root and main sections
            URLS="https://omnimetric.net/en
            https://omnimetric.net/jp
            https://omnimetric.net/cn
            https://omnimetric.net/es
            https://omnimetric.net/hi
            https://omnimetric.net/id
            https://omnimetric.net/ar
            https://omnimetric.net/commodities
            https://omnimetric.net/api/og/main?lang=EN
            https://omnimetric.net/api/og/main?lang=JP
            https://omnimetric.net/api/og/commodities?lang=ES"
            
            for url in $URLS; do
              curl -v "https://www.bing.com/indexnow?url=$url&key=$INDEXNOW_KEY"
              curl -v "https://yandex.com/indexnow?url=$url&key=$INDEXNOW_KEY"
            done
          fi
      - name: Commit Artifacts on Failure
        if: failure()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add backend/engine_log.txt backend/news_debug.log
          git commit -m "chore: save debug logs [bot]" || exit 0
          git push
      - name: CHECK AI STATUS (Private Alert)
        if: always() # Run even if commit output "No changes"
        run: |
          if [ -f backend/ai_failed.flag ]; then
            echo "::error::AI GENERATION FAILED (Stealth Cache Used)"
            echo "--- FAILURE FLAG CONTENT ---"
            cat backend/ai_failed.flag
            echo ""
            echo "--- ENGINE LOG DUMP ---"
            cat backend/engine_log.txt || echo "No engine log found"
            echo ""
            echo "--- NEWS DEBUG LOG DUMP ---"
            cat backend/news_debug.log || echo "No news debug log found"
            echo "Sending Private Alert to Owner..."
            exit 1
          fi
