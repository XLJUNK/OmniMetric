name: SNS Publisher (Independent)

on:
#  schedule:
#    - cron: '10,40 * * * *' # Run 5 minutes after the main update (5,35) to ensure data is ready
  workflow_dispatch:
    inputs:
      force_post:
        description: 'Force Post (Ignore Status Checks)'
        required: false
        type: boolean
        default: false

concurrency:
  group: sns-publish
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          
      - name: Run SNS Publisher
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
        run: |
          FORCE_FLAG=""
          if [ "${{ inputs.force_post }}" == "true" ]; then
            FORCE_FLAG="--force"
          fi
          
          echo "Running SNS Publisher..."
          python backend/sns_publisher.py $FORCE_FLAG

      - name: Commit SNS Status Updates
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Only commit the status files tracking last post
          git add backend/sns_status.json backend/sns_last_post.json
          
          git commit -m "chore: update sns status [bot]" || echo "No status changes to commit"
          
          git pull --rebase origin main || echo "Already up to date"
          git push origin main
